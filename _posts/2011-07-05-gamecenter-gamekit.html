---
layout: post
name: gamecenter-gamekit
title: GameCenter 以前の GameKit
time: 2011-07-05 11:55:00.000000000 +09:00
---
GameKit はもともと iOS 3.0 の頃から実装されていた。この頃は Peer To Peer とボイスチャットのみを扱う物であった。サーバが提供されていなかったため、LAN または bluetooth 上のデバイスしか検出できず（サーバたてれば別とは思う）、当時の利用方法としては Game よりも目の前の相手へのデータの転送などに使われていたのではないでしょうか。これが iOS 4.1 になって GameCenter が追加され Game アプリを作成する上で非常に大きな存在となった。ちなみに、4.0 にも API は存在するけど 4.1 で大幅な変更が加えられたため利用できない。<br /><br /><br /><br /><br /><section><br /><hgroup><br /><h1>Peer to Peer</h1><h2>GKSession</h2></hgroup><br /><pre class="brush: objc">GKSession *session = [[GKSession alloc] initWithSessionID:@"hoge" displayName:nil sessionMode:GKSessionModePeer];<br />session.delegate = self; <br />[session setDataReceiveHandler:self withContext:nil]; <br />session.available = YES;<br /></pre>Delegate は以下の通り。available = YES すると相手の session:peer:didChangeState が呼び出される。<br /><ul><li> session:peer:didChangeState:<br /></li><li> session:didReceiveConnectionRequestFromPeer:<br /></li><li> session:connectionWithPeerFailed:withError:<br /></li><li> session:didFailWithError:<br /></li></ul>setDataReceiveHandler:withContext: を実行しているので以下のメソッドも定義する必要がある。 <br /><ul><li> receiveData:fromPeer:inSession:<br /></li></ul>相手の Peer ID が分かれば connectToPeer:withTimeout:、 acceptConnectionFromPeer:error: の流れで接続する。  相手先にデータを送るには sendDataToAllPeers:withDataMode:error: または sendData:toPeers:withDataMode:error: を使う。  ここでいくつか注意をドキュメントから抜粋。 <br /><ol><li>一度に送れるデータのサイズは 87KB 以下。<br /></li><li>1KB以下であると良好なパフォーマンスが得られる。<br /></li><li>モードはGKSendDataReliable なら受信が成功するまで繰り返し、GKSendDataUnreliable なら一度だけ送る。<br /><i>GKSendDataReliable でも大きなデータ（画像など）を送っているとデータの欠落などが発生しエラーも発生しないみたい（未確認）なので、うまくいかない場合は自分で送受信でチェックを入れる</i><br /></li></ol><br />サンプル GKRocket にある SessionManager クラスを使うといろいろとやってくれて便利。  <br /></section><br /><br /><br /><section><br /><h1>GKPeerPickerController</h1>次のコードだけで Bluetooth による Peer to Peer ネットワークを作成してくれる。デフォルトでは Bluetooth のみ対応だけど、connectionTypesMask を設定すれば LAN も探してくれる。<br /><br /><pre class="brush: objc">GKPeerPickerController*		picker;  picker = [[GKPeerPickerController alloc] init]; <br />picker.delegate = self; [picker show]; <br /></pre>あとはデリゲートで対応する。peerPickerController:sessionForConnectionType: で GKSession 作って返す必要があるからそれだけ注意。 <br /><ul><li>peerPickerController:sessionForConnectionType:<br /></li><li>peerPickerController:didConnectPeer:toSession:<br /></li><li>peerPickerControllerDidCancel:<br /></li></ul>GKPeerPicker を使うと Bluetooth を ON にするダイアログを表示してくれるし、connect と accept も自動でやってくれるので楽チン。<br /></section><br /><br /><br /><section><br /><hgroup><br /><h1>Voice Chat</h1><h2>GKVoiceChatService</h2></hgroup><br />iOS4.1 からの GKVoiceChat と混同しない。GKVoiceChat もそうであるが、3G 環境などの Wi-Fi 以外の環境では動作しない。<br /><section><br /><h1>setup</h1>マイクとスピーカーを使うので AudioSession を扱う必要がある。AudioSession とは Device のマイクやスピーカーの状態や挙動を管理してくれる物で、サイレントモードで音を再生するかどうかを設定したりできる。<br />AudioSession には C の関数の他に AVFoundation クラスが用意されているの好きな方を使えば良い。<br /><pre class="brush: objc">NSError *myErr;<br />AVAudioSession *audioSession = [AVAudioSession sharedInstance];<br />[audioSession setPreferredHardwareSampleRate:8000.0 error:&amp;myErr];<br />[audioSession setCategory:AVAudioSessionCategoryPlayAndRecord error:&amp;myErr];<br />[audioSession setCategory:AVAudioSessionCategoryPlayAndRecord error:&amp;myErr];<br /><br />[GKVoiceChatService defaultVoiceChatService].client = self; //GKChatServiceClient protocol<br />[[GKVoiceChatService defaultVoiceChatService] setInputMeteringEnabled:YES]; <br />[[GKVoiceChatService defaultVoiceChatService] setOutputMeteringEnabled:YES];<br /></pre>client は (NSString*)participantID 定義してある必要がある。これによってチャット相手を識別するのだけど、GKSession と併せて使うことになるだろうから peerID を用いれば良い。<br /><pre class="brush: objc">- (NSString *)participantID<br />{ <br />	return self.session.peerID;<br />}<br /></pre></section><br /><br /><section><br /><h1>start chat service</h1>startVoiceChatWithParticipantID:error: メソッドで相手を捜し出し invite メッセージを送ってくれる。<br />受ける側は voiceChatService:didReceiveInvitationFromParticipantID:callID: を実装して、中で acceptCallID:error: を呼べば良い。<br /><br />これ以降は音声入力があると voiceChatService:sendData:toParticipantID: が呼ばれるので、中で GKSession の sendData:toPeers:withDataMode:error: で相手にデータを送る。<br />受ける側は receiveData:fromPeer:inSession:context: 内で GKVoiceChatService の receivedData:fromParticipantID: を呼べばスピーカーから音が出る。<br /><br />ソースコード書いた方が早かったかな？GKRocket の中の SessionManager クラスがとても参考になる。<br /></section><br /></section>
