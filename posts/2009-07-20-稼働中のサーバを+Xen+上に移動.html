		<div class="section">
			<p>昨日の続き。</p>
			<h4> 再度データの抽出</h4>
			<p>利用しようとしていたディスクイメージは、fsck によって大量の修復があった時点でそもそも信用のできるものではなかった。ので、改めでデータを抽出してみた。昨日とは違い fsck しても何のエラーも出さない。稼働中のサーバをネットワーク経由で抜き出すような事をすれば、ある程度の修復は致し方ないのかなと思っていたけど、違うみたいです。</p>
			<p>fsck で大量のチェックが入るような場合には再度やり直した方が良いと思う。</p>
			<h4> 32bit 版の CentOS を virt-install</h4>
			<p>問題のないデータでも動かなかった orz</p>
			<p>やり方がかなり強引な感はあったので、素直に 32bit 版を virt-install し、それをひな形にサーバを移行する事にした。</p>
			<p>で、virt-install で転けたw</p>
			<h5> virt-install とネットワーク</h5>
			<p>参考</p>
			<p><a href="http://www.asahi-net.or.jp/~aa4t-nngk/xen.html" target="_blank">Stray Penguin - Linux Memo (Xen)</a></p>
			<p>前回は Web サーバ上に CentOS のインストールイメージを置き、ネットワークインストールする方法をとった。今回はホストOS 上で DVD をマウントし、NFS で公開する方法で行った。</p>
			<blockquote>
			<p>準仮想化で virt-install を行う場合、直接 DVD ドライブを利用することはできない。</p>
			</blockquote>
			<p>うろ覚えだけど、Virbr ブリッジを使う場合、ネットワークの設定は DHCP でやってくれるとどこかに書いてあった気がした。たぶん、ぼくが変にいじってしまったのだと思うけど、DHCP が動作してくれなかったのでマニュアルで設定。</p>
			<p>まず、ホストOS で ifconfig virbr0 などして IP アドレス等を調べておく。うちの環境では 192.168.200.1 が設定されていた。</p>
			<p>これを参考に、192.168.200.5/255.255.255.0 を設定し、デフォルトゲートウェイを 192.168.200.1 に設定した。（実はネットワークの理解が曖昧で、ここで１時間くらい潰された）</p>
			<p>無事インストールは完了し、32bit OS でもなんら問題なく、64bit CentOSxen 上で動かす事ができた。</p>
			<p>あとは / を置き換えて、/lib/modules/****xen/ をコピーするだけで動作してくれそうなもの (64bit 版はそれで上手くいった）だけど、どうしても HAL daemon の起動の後で止まってしまう。</p>
			<p>ダメ元で virt-install した素の CentOS のファイル構成と、移行するサーバのファイル構成の差分をとって、不足分をコピーしてみたら動いた。</p>
			<p>脱力だけど、動いてくれたらそれで Happy です♪</p>
			<h5> 追記的な</h5>
			<p>Web サーバ経由の時はネットワークの設定も上手くやれていたよなあ、と別機で Web サーバ経由で virt-install してみたけど動かなかった orz</p>
			<p>前の時はかなり強引に無茶な事をやったみたいだ。普通に DVD + NFS 経由でインストールする方が早いし問題も少ないと思う。</p>
			<h4> まとめ</h4>
			<p>稼働中のサーバからネットワーク経由でデータを抽出し、サーバを Xen 上に移行するような場合、事前に virt-install を使って移行先のひな形を作成して置くのが良い。</p>
			<p>動作の保証された /lib/modules/***xen が使えるし、場合によっては足りないファイル持って来る事ができる。</p>
		</div>

